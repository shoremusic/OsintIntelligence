{% extends 'base.html' %}

{% block title %}Workflow Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Intelligence Gathering Workflows</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Workflow Definitions</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createWorkflowModal">
                        <i class="bi bi-plus-circle"></i> New Workflow
                    </button>
                </div>
                <div class="card-body">
                    {% if workflows %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Trigger Type</th>
                                        <th>Status</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for workflow in workflows %}
                                    <tr>
                                        <td>{{ workflow.name }}</td>
                                        <td>
                                            {% if workflow.trigger_type == 'manual' %}
                                                <span class="badge bg-info">Manual</span>
                                            {% elif workflow.trigger_type == 'schedule' %}
                                                <span class="badge bg-success">Scheduled</span>
                                            {% elif workflow.trigger_type == 'event' %}
                                                <span class="badge bg-warning">Event</span>
                                            {% else %}
                                                <span class="badge bg-secondary">None</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if workflow.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ workflow.updated_at }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary execute-workflow" data-workflow-id="{{ workflow.id }}">
                                                    <i class="bi bi-play-fill"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary edit-workflow" data-workflow-id="{{ workflow.id }}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger delete-workflow" data-workflow-id="{{ workflow.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No workflows defined yet. Click the "New Workflow" button to create one.
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Workflow Execution History</h5>
                </div>
                <div class="card-body">
                    {% if executions %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Workflow</th>
                                        <th>Status</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Duration</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for execution in executions %}
                                    <tr>
                                        <td>{{ execution.workflow.name }}</td>
                                        <td>
                                            {% if execution.status == 'running' %}
                                                <span class="badge bg-warning">Running</span>
                                            {% elif execution.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif execution.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ execution.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ execution.start_time }}</td>
                                        <td>{{ execution.end_time or 'N/A' }}</td>
                                        <td>
                                            {% if execution.end_time %}
                                                {% set duration = (execution.end_time - execution.start_time).total_seconds() %}
                                                {{ '%d:%02d:%02d' % (duration // 3600, duration % 3600 // 60, duration % 60) }}
                                            {% else %}
                                                Running...
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info view-execution" data-execution-id="{{ execution.id }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No workflow executions yet. Run a workflow to see results here.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Workflow Engine</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <button id="initialize-engine" class="btn btn-primary">
                            <i class="bi bi-lightning-charge"></i> Initialize Engine
                        </button>
                        <button id="start-engine" class="btn btn-success">
                            <i class="bi bi-play-circle"></i> Start Engine
                        </button>
                        <button id="stop-engine" class="btn btn-danger">
                            <i class="bi bi-stop-circle"></i> Stop Engine
                        </button>
                    </div>
                    <div class="alert alert-info">
                        <p><strong>Workflow Engine Status:</strong> <span id="engine-status">Unknown</span></p>
                        <p class="mb-0"><small>The workflow engine handles scheduled and event-triggered workflows automatically. You must initialize the engine before starting it.</small></p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Workflow Help</h5>
                </div>
                <div class="card-body">
                    <h6>Step Types:</h6>
                    <ul>
                        <li><strong>api_query</strong> - Query APIs for intelligence data</li>
                        <li><strong>llm_analysis</strong> - Analyze data using AI</li>
                        <li><strong>web_scrape</strong> - Extract data from websites</li>
                        <li><strong>data_store</strong> - Store collected data</li>
                        <li><strong>condition</strong> - Branch workflow based on conditions</li>
                    </ul>
                    <h6>Trigger Types:</h6>
                    <ul>
                        <li><strong>manual</strong> - Run workflow on demand</li>
                        <li><strong>schedule</strong> - Run workflow on a schedule</li>
                        <li><strong>event</strong> - Run workflow when new data appears</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Workflow Modal -->
<div class="modal fade" id="createWorkflowModal" tabindex="-1" aria-labelledby="createWorkflowModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createWorkflowModalLabel">Create New Workflow</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('workflows') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Workflow Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trigger_type" class="form-label">Trigger Type</label>
                        <select class="form-select" id="trigger_type" name="trigger_type">
                            <option value="manual">Manual</option>
                            <option value="schedule">Schedule</option>
                            <option value="event">Event</option>
                        </select>
                    </div>
                    
                    <div id="schedule-config" class="mb-3 d-none">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="schedule_enabled" name="schedule_enabled">
                                    <label class="form-check-label" for="schedule_enabled">
                                        Enable Schedule
                                    </label>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="frequency" class="form-label">Frequency</label>
                                        <select class="form-select" id="frequency" name="frequency">
                                            <option value="minutes">Minutes</option>
                                            <option value="hourly">Hourly</option>
                                            <option value="daily" selected>Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="interval" class="form-label">Interval</label>
                                        <input type="number" class="form-control" id="interval" name="interval" value="1" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="event-config" class="mb-3 d-none">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="event_type" class="form-label">Event Type</label>
                                    <select class="form-select" id="event_type" name="event_type">
                                        <option value="new_data">New Data</option>
                                        <option value="new_case">New Case</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="data_type" class="form-label">Data Type (Optional)</label>
                                    <select class="form-select" id="data_type" name="data_type">
                                        <option value="">Any Type</option>
                                        <option value="name">Name</option>
                                        <option value="phone">Phone</option>
                                        <option value="email">Email</option>
                                        <option value="social_media">Social Media</option>
                                        <option value="location">Location</option>
                                        <option value="vehicle">Vehicle</option>
                                        <option value="image">Image</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="steps" class="form-label">Workflow Steps (JSON)</label>
                        <textarea class="form-control font-monospace" id="steps" name="steps" rows="10" required>[
  {
    "type": "api_query",
    "api_selection": "auto"
  },
  {
    "type": "llm_analysis",
    "analysis_type": "comprehensive"
  }
]</textarea>
                        <div class="form-text">Define your workflow steps as a JSON array. See the help section for available step types.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Workflow</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Execution Details Modal -->
<div class="modal fade" id="executionDetailsModal" tabindex="-1" aria-labelledby="executionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="executionDetailsModalLabel">Workflow Execution Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="execution-details">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show/hide trigger configurations based on type
        const triggerTypeSelect = document.getElementById('trigger_type');
        const scheduleConfig = document.getElementById('schedule-config');
        const eventConfig = document.getElementById('event-config');
        
        triggerTypeSelect.addEventListener('change', function() {
            if (this.value === 'schedule') {
                scheduleConfig.classList.remove('d-none');
                eventConfig.classList.add('d-none');
            } else if (this.value === 'event') {
                scheduleConfig.classList.add('d-none');
                eventConfig.classList.remove('d-none');
            } else {
                scheduleConfig.classList.add('d-none');
                eventConfig.classList.add('d-none');
            }
        });
        
        // Execute workflow
        document.querySelectorAll('.execute-workflow').forEach(button => {
            button.addEventListener('click', function() {
                const workflowId = this.getAttribute('data-workflow-id');
                
                fetch(`/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Workflow execution started');
                        // Reload page after a short delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error executing workflow');
                });
            });
        });
        
        // Delete workflow
        document.querySelectorAll('.delete-workflow').forEach(button => {
            button.addEventListener('click', function() {
                if (!confirm('Are you sure you want to delete this workflow?')) {
                    return;
                }
                
                const workflowId = this.getAttribute('data-workflow-id');
                
                fetch(`/workflows/${workflowId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Workflow deleted');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting workflow');
                });
            });
        });
        
        // View execution details
        document.querySelectorAll('.view-execution').forEach(button => {
            button.addEventListener('click', function() {
                const executionId = this.getAttribute('data-execution-id');
                const detailsDiv = document.getElementById('execution-details');
                
                // Show loading spinner
                detailsDiv.innerHTML = `
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('executionDetailsModal'));
                modal.show();
                
                // Fetch execution details
                fetch(`/workflow_executions/${executionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Render execution details
                        const execution = data.execution;
                        const workflow = data.workflow;
                        const steps = data.steps;
                        
                        let stepsHtml = '';
                        steps.forEach(step => {
                            let statusBadge = '';
                            if (step.status === 'running') {
                                statusBadge = '<span class="badge bg-warning">Running</span>';
                            } else if (step.status === 'completed') {
                                statusBadge = '<span class="badge bg-success">Completed</span>';
                            } else if (step.status === 'failed') {
                                statusBadge = '<span class="badge bg-danger">Failed</span>';
                            }
                            
                            let duration = 'N/A';
                            if (step.end_time) {
                                const start = new Date(step.start_time);
                                const end = new Date(step.end_time);
                                const seconds = Math.floor((end - start) / 1000);
                                duration = `${Math.floor(seconds / 60)}:${(seconds % 60).toString().padStart(2, '0')}`;
                            }
                            
                            stepsHtml += `
                                <div class="card mb-2">
                                    <div class="card-header d-flex justify-content-between">
                                        <span>Step ${step.step_number}: ${step.step_type}</span>
                                        <span>${statusBadge}</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Started:</strong> ${new Date(step.start_time).toLocaleString()}</p>
                                                <p><strong>Duration:</strong> ${duration}</p>
                                            </div>
                                            <div class="col-md-6">
                                                ${step.error ? `<p class="text-danger"><strong>Error:</strong> ${step.error}</p>` : ''}
                                            </div>
                                        </div>
                                        ${step.result ? `
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#stepResult${step.id}">
                                                    Show/Hide Result
                                                </button>
                                                <div class="collapse mt-2" id="stepResult${step.id}">
                                                    <pre class="bg-dark text-light p-3 rounded"><code>${JSON.stringify(step.result, null, 2)}</code></pre>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        detailsDiv.innerHTML = `
                            <div class="mb-3">
                                <h5>Execution #${execution.id}: ${workflow.name}</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> 
                                            ${execution.status === 'running' ? '<span class="badge bg-warning">Running</span>' : ''}
                                            ${execution.status === 'completed' ? '<span class="badge bg-success">Completed</span>' : ''}
                                            ${execution.status === 'failed' ? '<span class="badge bg-danger">Failed</span>' : ''}
                                        </p>
                                        <p><strong>Started:</strong> ${new Date(execution.start_time).toLocaleString()}</p>
                                        <p><strong>Finished:</strong> ${execution.end_time ? new Date(execution.end_time).toLocaleString() : 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        ${execution.error ? `<p class="text-danger"><strong>Error:</strong> ${execution.error}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <h6>Execution Steps</h6>
                            ${stepsHtml}
                        `;
                    } else {
                        detailsDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    detailsDiv.innerHTML = `<div class="alert alert-danger">Error fetching execution details</div>`;
                });
            });
        });
        
        // Engine control
        document.getElementById('initialize-engine').addEventListener('click', function() {
            fetch('/initialize_workflow_engine', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('engine-status').textContent = 'Initialized';
                    document.getElementById('engine-status').className = 'text-primary';
                    alert('Workflow engine initialized');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error initializing workflow engine');
            });
        });
        
        document.getElementById('start-engine').addEventListener('click', function() {
            fetch('/start_workflow_engine', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('engine-status').textContent = 'Running';
                    document.getElementById('engine-status').className = 'text-success';
                    alert('Workflow engine started');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting workflow engine');
            });
        });
        
        document.getElementById('stop-engine').addEventListener('click', function() {
            fetch('/stop_workflow_engine', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('engine-status').textContent = 'Stopped';
                    document.getElementById('engine-status').className = 'text-danger';
                    alert('Workflow engine stopped');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error stopping workflow engine');
            });
        });
    });
</script>
{% endblock %}